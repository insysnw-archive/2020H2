# Module common

### Описание общего протокола

В данном модуле описывается общее представление данных обоих протоколов 
приложений sevent и nrating. Оба протокола работают поверх транспортного 
протокола, который представляет данные в виде потока октетов с гарантией 
доставки (TCP). Протоколы приложений, использующие данный протокол кодируют 
целые числа в формате big endian, где старший бит -- это первый в потоке, 
если не сказано другое.

Протоколы приложений, основывающиеся на данном протоколе реализуют две роли, 
в которых могут участвовать приложения: клиент и сервер.

Каждый поток октетов ассоциируется с сессией, которая может иметь набор 
атрибутов. Таким образом подключение напрямую связано с понятием сессии и 
каждое подключение формирует сессию и обеспечивает двусторонний поток октетов.

Существует 2 потока октетов (направления потока октетов): от клиента к серверу 
и от сервера к клиенту. Каждый поток может отдельно определять возможные 
типы опций отдельных сообщений и типы самих сообщений.

Сервер должен обеспечивать работу нескольких сессий, независимо от протокола 
приложения.

Клиент должен быть инициатором сессии независимо от протокола приложения.

Протокол делит поток октетов на отдельные сообщения произвольной длины. 
Каждое сообщение представляет собой набор следующих полей, которые идут друг 
за другом в потоке октетов: **size**, **id**, **options** и **body**. 

#### Описание полей отдельного сообщения

##### Поле **size** 

Это поле представляет собой целое беззнаковое 32-ух битное число, 
закодированное в формате [varint]. Оно хранит в себе количество октетов 
всего сообщение за исключением самого поля size.

##### Поле **id**

Это один октет, целое беззнаковое число, которое определяет тип всего
сообщения. Используется для указания поведения сервера или клиента при получении
сообщения. Может иметь значения в диапазоне 0-127. Остальные значения 
являются запрещёнными.

##### Поле **options**

Это поле содержит набор опций произвольного количества. Каждая опция состоит 
из трёх полей: **option_type**, **option_size** и **option_body**. 
**options** используются предметноориентированным протоколом в случае 
изменения поведения при наличии опции. Опция может также представлять собой
поле, которое может быть использовано не зависимо от типа сообщения 
(**id**).

Описание полей опции:

* **option_type** -- октет, указывающий тип опции. Набор типов опций 
  определяется протоколом приложения и направлением потока октетов. Тип опции 
  это целое беззнаковое число в диапазоне 1-127. Значения выше 127 запрещены. 
  Значение 0 указывает на конец поля **options**. При значении 0 поля опции 
  **option_size** и **option_body** отсутствуют.
* **option_size** -- целое беззнаковое 32-ух битное число, закодированное 
  форматом [varint], указывающее размер поля **option_body** в количестве 
  октетов.
* **option_body** -- набор октетов, чьё количество определено предшествующим 
  полем **option_size**, а формат определяется предшествующим кодом типа 
  (**option_type**), направлением потока октетов и протоколом.

##### Поле **body**

Представляет собой произвольный набор октетов.

Содержимое этого поля определяется протоколом приложения, типом сообщения 
(**id**), направлением потока октетов и набором опций. Размер этого поля 
определяется полем **size** за вычетом количества октетов в полях **id** и 
**options**.

#### Описание типов данных

Независимо от протокола приложения можно встретить одинаковые типы данных, 
которые могут составлять содержимое поля **body** и **option_body**. Они 
перечислены в данном разделе.

##### *VarInt*

Это целое беззнаковое 32-ух битное число, произвольного размера, которое 
кодируется форматом [varint].

##### *Bytes*

Набор последовательных октетов. Количество октетов, составляющее
данный тип данных определяется контекстом (например, это может быть 
фиксированный размер, определённый протоколом, количество оставшихся октетов 
поля).

##### *String*

Данный тип инкапсулирует *Bytes*.

Набор последовательных символов формата UTF-8. Коды отдельных символов 
берутся из октетов поля *Bytes*, которое данный тип инкапсулирует.

##### *VarBytes*

Данный тип инкапсулирует последовательно типы *VarInt* и *Bytes*.

В поле типа *VarInt* хранится количество октетов в поле типа *Bytes*. При этом 
содержимое поля типа *Bytes* определяет значение поля типа *VarInt* (в 
приложении размер массива байтов должно задавать количество отправляемых 
октетов).

##### *VarString*

Данный тип инкапсулирует тип *VarBytes*.

Набор последовательных символов формата UTF-8. Коды отдельных символов
берутся из октетов поля *VarBytes*, которое данный тип инкапсулирует.

##### *Byte*, *Short*, *Int*, *Long*

Данные типы определяют целые знаковые числа фиксированной длины.

|Тип  |Количество октетов|Диапазон                                |
|-----|------------------|----------------------------------------|
|Byte |1                 |-128:127                                |
|Short|2                 |-65536:65535                            |
|Int  |4                 |-2147483648:2147483647                  |
|Long |8                 |-9223372036854775808:9223372036854775807|

##### *Float*, *Double*

Дробное число с плавающей запятой, формат IEEE 754.

Тип *Float* одинарной точности, а *Double* расширенной.

##### *Time*

Данный тип инкапсулирует тип *Long*.

Этот тип представляет собой количество секунд в формате UNIX. Значение 
храниться в инкапсулированном типе *Long*.

##### *List<Type>*

Тип *List<Type>* это шаблонный тип, который содержит в себе последовательно 
элементы одного указанного типа `Type` в количестве, зависимом от контекста. 
Так например тип *List<Int>* представляет собой список целых 32-ух битных чисел.

##### *VarList<Type>*

Данный тип инкапсулирует последовательно типы *VarInt* и *List<Type>*.

В поле типа *VarInt* хранится элементов в поле типа *List<Type>*. При 
этом содержимое поля типа *VList<Type>arInt* определяет значение поля типа
*VarInt*.

[varint]: https://developers.google.com/protocol-buffers/docs/encoding#varints
